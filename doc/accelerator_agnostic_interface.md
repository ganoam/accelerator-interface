# Accelerator-Agnostic Cores

To decouple the development of accelerators and cores, it may be beneficial separate the handling of offloaded instructions from the rest of the core's operation.

The interaction with the accelerator interface does not necessarily need to originate from the offloading core itself.
Optimally, no change to the HDL of a core would be necessary in order to support custom ISA extensions.
In order for the accelerator interface to be used with an accelerator-agnostic core, the necessary signals need to be generated outside of the core.
An external pre-decoder structure may be implemented to facilitate this use case.

The documentation provides *preliminary* information.
The specification of this part of the interface is currently under development.
To take part in the discussion, please refer to the corresponding [issue](https://github.com/ganoam/accelerator-interface/issues/1).

## Accelerator Adapter
The accelerator adapter is a hardware extension to the instruction decoder of the offloading core.
It is a modular structure, implementing an array of dedicated predecoders representing each of the connected accelerators.
The predecoders are connected in parallel to the decoder in the offloading core and are understood as an architectural extension of the decoding stage.
Analogously an array of compressed predecoders is implemented to expand eventual compressed offload instructions.
Furthermore, the accelerator adapter implemments an immediate decoder, operand multiplexers and capability for communication with the offloading core and the accelerator interconnect.

![Accelerator Agnostic Core](img/acc-agnostic-core.svg)

###  Offload Request Interface Signals

The pre-decoder communicates to the offloading core via the the following signals.

| Name                | Range           | Dicection           | Description                                                  |
| ------------------- | --------------- | ------------------- | ------------------------------------------------------------ |
| `offload_valid`     | `0:0`           | Core -> Adapter     | Initiate offloading process.                                 |
| `offload_ready`     | `0:0`           | Adapter     -> Core | All information accquired. Complete transaction.             |
| `offload_accept`    | `0:0`           | Adapter     -> Core | Instruction accepted by external accelerator.                |
| `offload_wb`        | `1:0`           | Adapter     -> Core | Expect writeback on registers `{rd_address, rd_address+1}`). |

The following signals are non-handshaked architecture extension signals.
| Name                | Range           | Dicection           | Description                                      |
| ------------------- | --------------- | ------------------- | ------------------------------------------------ |
| `rs1`, `rs2`, `rs3` | `DataWidth-1:0` | Core -> Adapter     | Source register contents.                        |
| `rs_valid`          | `2:0`           | Core -> Adapter     | Source register `i` is valid                     |
| `instr_rdata_id`    | `31:0`          | Core -> Adapter     | RISC-V instruction data (ID Stage)               |
| `instr_rdata_if`    | `31:0`          | Core -> Adapter     | RISC-V instruction data (IF Stage)               |
| `instr_if_exp`      | `31:0`          | Adapter -> Core     | Expanded compressed instruction data             |
| `instr_if_exp_valid`| `0:0`           | Adapter -> Core     | Expanded compressed Instruction data is valid    |

Remarks:
- The transaction is initiated by the core using `offload_valid` and terminated by the pre-decoder using `offload_ready`.
  The offloading core must stall, until a transaction is resolved (single-cycle transactions are permitted).
- Source register data in the offloading core may be invalid for several reasons.
  For example, the source register address may be reserved be an outstanding writebac from another offloaded instruction.
  The status of each source register is indicated by the individual bits of `rs__valid`.
  `rs__valid` may change during the course of a transaction (e.g. writeback has occured).
  If an instruction is to be offloaded which depends on a source register marked as invalid, the pre-decoder may not complete the transaction until it is validated.
- `offload_accept` indicates the instruction is a accepeted by one of the connected accelerators.
  If a transaction is completed without asserting `offload_accept`, the core must raise an illegal instruction exception.

### Operating Principle
The instruction offloading process takes place without further information on the nature of the performed operation to the core.
The RISC-V instruction data, the three source registers and a set of custom pre-decoder interface signals are permanently exposed by the offloading core to the pre-decoder structure.
Additionally valid status information on the exposed source register data is generated by the offloading core.

#### Instruction Offloading
The sequence for offloading instructions to external accelerators is as follows
- Upon encountering an unknown instruction in the core's decoder, an instruction offload process is initiated by raising `offload_vaild`.
- The instruction data is fed into each of the dedicated accelerator subdecoders.
  Upon encountering an offloadable instruction, a subdecoder generates operand select signals `offl_ops_sel`, determines weather to expect writeback from this operation `offl_wb` and raises `offl_accept`.
  The signal `offload_wb` indicates to the core weather to expect writeback from this operation.
  `offload_wb[0]` corresponds to the default destination register address.
  `offload_wb[1]` corresponds to the default destination register address incremented by 1 (see [base specification](index.md)).

  If writeback is expected, the core must reserve the destination register in its scoreboard.
- The collection of `offload_accept` signals from the subdecoders is used to determine the accelerator address to which the instruction will be offloaded by the interconnect handshaker and to indicate a valid offload instruction to the core handshaker.
- The signal `offload_rs_valid` indicates to the pre-decoder which of the exposed source register data is currently valid.
  The pre-decoder may stall the offloading core by delaying the `offload_ready` signal while waiting for valid source registers.
  For instructions not using source registers, the corresponding valid signal is to be ignored by the pre-decoder.
- Once all necessary operands are valid (determined by `offl_ops_sel` generated by the accepting subdecoder and `rs__valid` originating from the offloading core) the core handshaker module completes the transaction by raising `offload_ready`.
- If no accelerator indicates acceptance of the offload request, the transaction is completed with `offload_accept` low, indicating the core has encountered an illegal instruction.
- The accelerator interconnect handshaker is in charge of communication with the accelerator interconnect as defined in the [base specification](index.md).

#### Instruction Writeback

The write-back process for offloaded instructions is no different that for the non-agnostic core.
Upon an accelerator response, the offloading core must write back the result to its register file and lift the reservation on the destination register address.
Communication with the response-side of the accelerator interconnect is to be implemented in the offloading core logic.

## Open Questions
### How to handle compressed instructions?
The

- How to handle compressed instructions? - see [Issue](https://github.com/ganoam/accelerator-interface/issues/3).
- How to handle multiple-writeback instructions?

